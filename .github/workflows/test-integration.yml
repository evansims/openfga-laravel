name: "Integration Tests"

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  integration-tests:
    name: "PHP 8.3 with Coverage"
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          echo "Building test image with latest code..."
          docker buildx build \
            --tag evansims/openfga-laravel-integration-tests:latest \
            --file Dockerfile.integration \
            --load \
            .

          # Show image info
          echo "Built test image:"
          docker images evansims/openfga-laravel-integration-tests:latest --format "Repository: {{.Repository}} Size: {{.Size}}"

      - name: Run integration tests
        run: |
          # Use the regular compose file with the freshly built image
          docker compose -f docker-compose.integration.yml up -d openfga otel-collector
          sleep 10
          docker compose -f docker-compose.integration.yml run --rm test

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.integration.yml down -v
          docker ps -a --filter label=com.openfga.test=integration -q | xargs -r docker rm -f || true
